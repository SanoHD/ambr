<!DOCTYPE html>
<html lang="en" dir="ltr">
	<head>
		<meta charset="utf-8">
		<title>ambr</title>
		<link rel="stylesheet" type="text/css" href="css/main.css">
	</head>
	<body style="padding: 20px">
		<div id="sidenav">
		</div>

		<div id="content">
			<input id="content-title" value="a project">
			<input id="content-description" value="a description">

			<div id="board">
				<table>
				</table>
			</div>
		</div>

		<script type="text/javascript">
			const fs = require("fs");
			let projects = [
				{
					"title": "Creating ambr",
					"color": "#ffaa66",
					"description": "uwu",
					"stages": [
						{
							"title": "To-do",
							"cards": {
								"5cdb8cb0e5e6cc4a78a72d2b47e23fba": {
									"text": "do something"
								},
								"150961aba3e1a4aded166b688eb59649": {
									"text": "do another thing"
								}
							}
						},
						{
							"title": "Finished",
							"cards": {
								"195673556ba1cf8efc507bba480ec046": {
									"text": "nothing lol"
								},
								"cb3ba35f40fa0edbd353f63cc6824fc6": {
									"text": "heeyyy Vsauce, Mchael here. This is a pretty long sentence. Or is it?"
								},
								"05b70f0ba3ccb6259ac0cb4bc1c2375a": {
									"text": "(Bottom text)"
								}
							}
						}
					]
				}
			];

			function idGen() {
				let id = "";
				let hex = "0123456789abcdef".split("");
				for (var i = 0; i < 32; i++) {
					id += hex[Math.floor(Math.random() * hex.length)];
				}
				return id;
			}

			function calcCursorDistance(element, mx, my) {
				// From https://www.kirupa.com/html5/get_element_position_using_javascript.htm

				var xPos = 0;
				var yPos = 0;

				let _element = element;
				while (element) {
					xPos += (element.offsetLeft - element.scrollLeft + element.clientLeft);
					yPos += (element.offsetTop - element.scrollTop + element.clientTop);
					element = element.offsetParent;
				}

				// Positions of element
				let x1 = xPos;
				let y1 = yPos;

				// Positions of mouse
				let x2 = mx - (_element.clientWidth / 2);
				let y2 = my - (_element.clientHeight / 2);

				// Calculate distance
				let dist = Math.sqrt(Math.pow(x1 - x2, 2) + Math.pow(y1 - y2, 2));

				return dist;
			}

			function cardRemove(id, cellIndex) {
				for (var column of Object.keys(currentProject["stages"][cellIndex])) {
					if (column == id) {
						delete column;
					}
				}
			}

			function cardAdd(id, content, posY) {
				currentProject["stages"][cellIndex][id] = content;
			}

			function getChildIndex(child) {
				var i = 0;
				while ((child = child.previousSibling) != null) {
					i++;
				}

				return i;
			}

			function insertCardIntoStage(stage, cardId, card, index) {
				// Mostly from https://stackoverflow.com/questions/63030107/insert-property-into-object-at-specific-index-in-vanilla-js

				if (Object.keys(stage).length == 0) {
					return {cardId: card};
				}

				var stagesArray = Object.entries(stage);
				if (index == 0) {
					var newStagesObject = Object.fromEntries([
					    ...[[cardId, card]],
					    ...stagesArray
					]);
				} else {
					var newStagesObject = Object.fromEntries([
					    ...stagesArray.slice(0, index - 1),
					    stagesArray[index - 1],
					    ...[[cardId, card]],
					    ...stagesArray.slice(index)
					]);
				}

				return newStagesObject;
			}

			function findStageFromId(id) {
				for (var stage of currentProject["stages"]) {
					for (var card of Object.keys(stage["cards"])) {
						if ("card-" + card == id) {
							return stage["title"];
						}
					}
				}
				return false;
			}

			function getCardsFromStage(stageTitle) {
				for (var stage of currentProject["stages"]) {
					if (stage["title"] == stageTitle) {
						return stage["cards"];
					}
				}
			}

			function getStageIndex(stageTitle) {
				for (var stage in currentProject["stages"]) {
					if (currentProject["stages"][stage]["title"] == stageTitle) {
						return stage;
					}
				}

				return false;
			}

			function dragStart(event) {
				draggedCard = this;
				droppedCard = null;
				setTimeout(() => (this.classList.add("card-content-invisible")), 0);

				dragging = setInterval(function() {
					var closestElement = null;  // The element
					var closestDistance = null;  // The distance of this element
					var dist;

					// Get the closest drop area element relative to mouse
					for (var dropArea of document.getElementsByClassName("drop-area")) {
						dist = calcCursorDistance(dropArea, mouseX, mouseY);
						//console.log(dist, closestDistance);
						if (closestDistance == null || closestElement == null || dist < closestDistance) {
							//console.log("  SET TO", dist);
							closestDistance = dist;
							closestElement = dropArea;
						}
					}

					if (closestDistance == null || closestElement == null) {
						return;
					}

					closestDropArea = closestElement.firstChild;

					if (closestDropArea == null) {
						return;
					}

					// Remove styles of other classes that are not near the cursor
					for (var el of document.getElementsByClassName("drop-area")) {
						if (el != closestElement) {
							closestElement.style.backgroundColor = "";
							closestElement.classList.remove("drop-area-hover");
							closestElement.classList.add("drop-area-hover-leave");
						}
					}

					closestElement.classList.remove("drop-area-hover-leave");
					closestElement.classList.add("drop-area-hover");
					//closestElement.style.backgroundColor = "#ff7799";

				}, 50);
			}

			function dragEnd() {
				clearInterval(dragging);
				draggedCard = null;
				this.style.opacity = 0;
				this.classList.remove("card-content-invisible");
				reloadContent();
			}

			function dragEnter() {
				this.style.opacity = 1;
			}

			function dragOver(event) {
				/*
				this.style.paddingBottom = "15px";

				this.classList.remove("drop-area-hover-leave");
				this.classList.add("drop-area-hover");
				*/

				event.preventDefault();
			}

			function dragDrop(event) {
				let x = event.target.parentNode.cellIndex;
				let y = getChildIndex(event.target.parentNode.parentNode) / 2 - 0.5;
				let cardId = draggedCard.id.slice(5);

				//console.log(draggedCard.id, "->", "X = " + x + ", Y = " + y);

				// findStageFromId can return false, add an error for this
				let stage = findStageFromId(draggedCard.id)
				let newStage = currentProject["stages"][x]["title"]

				// Temporary save card
				/*
				console.dir(currentProject["stages"]);
				console.log(stage);
				console.log(cardId);
				*/

				let card = getCardsFromStage(stage)[cardId];

				// Remove card from stage
				delete getCardsFromStage(stage)[cardId];

				// Add card to stage
				let stageIndex = getStageIndex(newStage);
				let newCards = insertCardIntoStage(currentProject["stages"][stageIndex]["cards"], cardId, card, y);

				currentProject["stages"][stageIndex]["cards"] = newCards;

				this.style.opacity = 0;
				droppedCard = cardId;
			}

			function dragLeave() {
				this.style.opacity = 0;
				/*
				this.classList.remove("drop-area-hover");
				this.classList.add("drop-area-hover-leave");
				*/
			}

			currentProject = projects[0];
			var draggedCard = null;
			var droppedCard = null;  // Id

			var mouseX;
			var mouseY;
			document.body.addEventListener("drag", function(event) {
				mouseX = event.x;
				mouseY = event.y;
			});

			document.getElementById("content-title").value = currentProject["title"];
			document.getElementById("content-description").value = currentProject["description"];

			let sidenav = document.getElementById("sidenav");
			for (var project of projects) {
				let snproj = document.createElement("a");
				snproj.innerHTML = project["title"];
				snproj.classList.add("sidenav-project");
				sidenav.appendChild(snproj);
			}

			function reloadContent() {
				let table = document.getElementById("board").getElementsByTagName("table")[0];
				table.innerHTML = "";

				let stageRow = document.createElement("tr");
				for (var stageIndex in currentProject["stages"]) {
					let stageTitle = document.createElement("th");
					stageTitle.innerHTML = currentProject["stages"][stageIndex]["title"];
					stageTitle.classList.add("content-table-title");
					stageRow.appendChild(stageTitle);
				}

				table.appendChild(stageRow);

				var dropAreaRow = document.createElement("tr");
				for (var i = 0; i < Object.keys(currentProject["stages"]).length; i++) {
					let dropAreaElement = document.createElement("td");
					dropAreaElement.classList.add("drop-area");

					let dropArea = document.createElement("div");
					dropArea.addEventListener("dragenter", dragEnter);
					dropArea.addEventListener("dragover", dragOver);
					dropArea.addEventListener("drop", dragDrop);
					dropArea.addEventListener("dragleave", dragLeave);
					dropArea.style.border = "2px solid #4f7";
					dropArea.style.opacity = 0;
					dropAreaElement.appendChild(dropArea);
					dropAreaRow.appendChild(dropAreaElement);
				}
				table.appendChild(dropAreaRow);

				let level = 0;
				while (true) {
					let allUndefined = true;
					let elementsList = [];
					let row = document.createElement("tr");
					row.classList.add("content-table-row");

					for (var stage of currentProject["stages"]) {
						let card = document.createElement("td");
						card.classList.add("card");
						card.draggable = true;
						card.addEventListener("dragstart", dragStart);
						card.addEventListener("dragend", dragEnd);

						let textContentKey = Object.keys(stage["cards"])[level];

						let textElement = document.createElement("input");
						textElement.classList.add("card-content")

						if (textContentKey !== undefined) {
							let textContent = stage["cards"][textContentKey]["text"];
							card.id = "card-" + textContentKey;

							allUndefined = false;
							textElement.value = textContent;
							elementsList.push(textContent);
						} else {
							textElement.value = "";
							card.style.opacity = 0;
							elementsList.push(undefined);
						}

						card.appendChild(textElement);

						row.appendChild(card);
					}

					table.appendChild(row);

					var dropAreaRow = document.createElement("tr");
					for (var i = 0; i < Object.keys(currentProject["stages"]).length; i++) {
						/*
						if (currentProject["stages"][i].length == 0) {
							continue;
						}
						*/

						let dropAreaElement = document.createElement("td");
						dropAreaElement.classList.add("drop-area");

						if (elementsList[i] !== undefined) {
							let dropArea = document.createElement("div");
							dropArea.addEventListener("dragenter", dragEnter);
							dropArea.addEventListener("dragover", dragOver);
							dropArea.addEventListener("drop", dragDrop);
							dropArea.addEventListener("dragleave", dragLeave);
							dropArea.style.border = "2px solid #4f7";
							dropArea.style.opacity = 0;
							dropAreaElement.appendChild(dropArea);
						}
						dropAreaRow.appendChild(dropAreaElement);
					}
					table.appendChild(dropAreaRow);

					level++;
					if (allUndefined) {
						break;
					}
				}

				let dropArea = document.createElement("div");
				dropArea.addEventListener("dragEnter", dragEnter);
				dropArea.addEventListener("dragOver", dragOver);
				dropArea.addEventListener("dragDrop", dragDrop);
				dropArea.addEventListener("dragLeave", dragLeave);
				dropArea.style.border = "2px solid red";


				let snprojects = document.getElementsByClassName("sidenav-project");
				for (var i = 0; i < projects.length; i++) {
					let singleProject = snprojects[i];
					singleProject.style.borderLeft = "10px solid " + projects[i]["color"];
					singleProject.onmouseover = function() {
						singleProject.style.borderLeftWidth = "30px";
						singleProject.style.backgroundColor = "#f0f0f0";
					};
					singleProject.onmouseleave = function() {
						singleProject.style.borderLeftWidth = "10px";
						singleProject.style.backgroundColor = "#f9f9f9";
					};
				}

				if (droppedCard != null) {
					try {
						let tempCard = document.getElementById("card-" + droppedCard);
						let tempCardContent = tempCard.firstElementChild;
						tempCard.classList.add("card-drop-animation");
						tempCardContent.classList.add("card-content-drop-animation");
						setTimeout(function() {
							tempCard.classList.remove("card-drop-animation");
							tempCardContent.classList.remove("card-content-drop-animation");
						}, 1500);
					} catch (e) {

					}
				}
			}

			reloadContent();
		</script>
	</body>
</html>
