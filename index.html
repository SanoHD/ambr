<!DOCTYPE html>
<html lang="en" dir="ltr">
	<head>
		<meta charset="utf-8">
		<title>ambr</title>
		<link rel="stylesheet" type="text/css" href="css/main.css">
	</head>
	<body style="padding: 20px">
		<div id="context-menu-card"></div>

		<div id="sidenav"></div>
		<div id="content"></div>

		<div id="footer"></div>

		<script type="text/javascript">
			const copy = require("copy-to-clipboard");
			const fs = require("fs");

			let projects = [
				{
					"title": "Creating ambr",
					"color": "#ffaa66",
					"description": "uwu",
					"stages": [
						{
							"title": "To-do",
							"cards": {
								"5cdb8cb0e5e6cc4a78a72d2b47e23fba": {
									"text": "do something"
								},
								"150961aba3e1a4aded166b688eb59649": {
									"text": "do another thing"
								}
							}
						},
						{
							"title": "Finished",
							"cards": {
								"195673556ba1cf8efc507bba480ec046": {
									"text": "nothing lol"
								},
								"cb3ba35f40fa0edbd353f63cc6824fc6": {
									"text": "heeyyy Vsauce, Michael here. This is a pretty long sentence. Or is it?"
								},
								"05b70f0ba3ccb6259ac0cb4bc1c2375a": {
									"text": "(Bottom text)"
								},
								"b05f1451fbed4e7cbf57cfb511077c2d": {
									"text": "PROGRESS!"
								}
							}
						}
					]
				}
			];

			function genId() {
				/*
				This function generates a 32-character long hex id used
				for cards. Their HTML-Ids will look like this: "card-ba8732..."
				*/

				let id = "";
				let hex = "0123456789abcdef".split("");
				for (var i = 0; i < 32; i++) {
					id += hex[Math.floor(Math.random() * hex.length)];
				}
				return id;
			}

			function setFooterInfo(text) {
				let footer = document.getElementById("footer");

				let idsInFooter = [];
				for (var tn of footer.children) {
					idsInFooter.push(tn.id);
				}

				if (idsInFooter.includes("footer-info")) {
					// If there already is text in the footer, wait until its gone
					// and try again after some time. A delay is given by the second setTimeout function
					setTimeout(function() {
						setFooterInfo(text);
					}, 500);

				} else {
					let infoText = document.createElement("p");
					infoText.id = "footer-info";
					infoText.innerHTML = text;
					footer.appendChild(infoText);

					// Remove the text after 2 seconds (2000 milliseconds, duh!)
					setTimeout(function() {
						footer.removeChild(infoText);
					}, 2000);
				}
			}

			function loadLayout(projectIndex) {
				currentProject = projects[projectIndex];

				let content = document.getElementById("content");
				content.innerHTML = "";  // Clear content div

				let title = document.createElement("input");  // Title
				title.id = "content-title";
				title.value = currentProject["title"];
				title.spellcheck = false;

				let description = document.createElement("input");  // Description
				description.id = "content-description";
				description.value = currentProject["description"];
				description.spellcheck = false;

				// Add "add stage" button
				let addStageButton = document.createElement("div");
				addStageButton.classList.add("add-button");
				addStageButton.innerHTML = "+ Stage";
				addStageButton.style.float = "right";
				addStageButton.style.marginTop = "100px";
				addStageButton.style.marginRight = "50px";
				addStageButton.onclick = addStage;

				let board = document.createElement("div");  // The board itself
				board.id = "board";

				let boardTable = document.createElement("table");  // The board table

				// For the "add stage" button
				boardTable.style.width = "80%";
				boardTable.style.float = "left";

				board.appendChild(addStageButton);
				board.appendChild(boardTable);  // Add board table to table div

				50 +

				// Combine all
				content.appendChild(title);
				content.appendChild(description);
				content.appendChild(board);

				loadSidenav()
				loadContent();
			}

			function loadSidenav() {
				// Add all available projects
				let sidenav = document.getElementById("sidenav");
				sidenav.innerHTML = "";
				for (var pi in projects) {
					let snproj = document.createElement("a");
					snproj.innerHTML = projects[pi]["title"];

					snproj.style.borderLeft = "10px solid " + projects[pi]["color"];

					snproj.onmouseover = function() {
						snproj.style.borderLeftWidth = "30px";
						snproj.style.backgroundColor = "#f0f0f0";
					};

					snproj.onclick = function() {
						loadLayout(getChildIndex(this));
					}

					snproj.onmouseleave = function() {
						snproj.style.borderLeftWidth = "10px";
						snproj.style.backgroundColor = "#f9f9f9";
					};

					snproj.classList.add("sidenav-project");
					sidenav.appendChild(snproj);
				}

				// Add "add project" button
				let addProjectButton = document.createElement("div");
				addProjectButton.classList.add("add-button");
				addProjectButton.innerHTML = "+ Project";
				addProjectButton.onclick = addProject;
				sidenav.appendChild(addProjectButton);
			}

			function cardContextMenu(event) {
				let clickedCard;
				// Check if the user clicked on the text. If so, it should
				// work the same as when the user clicked its outer box (its parent)
				if (event.target.tagName != "TD") {
					clickedCard = event.target.parentNode;
				} else {
					clickedCard = event.target
				}

				let cm = document.getElementById("context-menu-card");

				// Reset context menu
				cm.style.display = "none";

				// Open context menu
				if (settings["slide-context-menu-card"]) {
					cm.style.display = "block";
					cm.style.left = event.clientX + "px";
					cm.style.top = event.clientY + "px";
				} else {
					setTimeout(function() {
						cm.style.display = "block";
						cm.style.left = event.clientX + "px";
						cm.style.top = event.clientY + "px";
					}, 0);
				}

				/*
				<p style="background-color: #ffeeee">Delete Card</p>
				*/

				let optionCopyText = document.createElement("p");
				optionCopyText.innerHTML = "Copy Text";
				optionCopyText.onclick = function() {
					copy(clickedCard.firstElementChild.value);
					setFooterInfo("Copied Text to Clipboard");
				}

				let optionCopyCardId = document.createElement("p");
				optionCopyCardId.innerHTML = "Copy Card ID";
				optionCopyCardId.onclick = function() {
					copy(clickedCard.id.slice(5));
					setFooterInfo("Copied Card ID to Clipboard");
				}

				let optionDeleteCard = document.createElement("p");
				optionDeleteCard.innerHTML = "Delete Card";
				optionDeleteCard.style.backgroundColor = "#ffeeee";
				optionDeleteCard.onclick = function() {
					cardRemove(clickedCard.id.slice(5));
				}

				cm.innerHTML = ""; // Clear context menu first
				cm.appendChild(optionCopyText);
				cm.appendChild(optionCopyCardId);
				cm.appendChild(optionDeleteCard);
			}

			function cardContextMenuClose() {
				document.getElementById("context-menu-card").style.display = "none";
			}

			function randomColor() {
				let hue = Math.floor(Math.random() * 361);
				let sat = 100;
				let light = 60;

				return "hsl("+hue+", "+sat+"%, "+light+"%)";
			}

			function addProject() {
				let newProject = {
					"title": "My Project",
					"color": randomColor(),
					"description": "Add a description here!",
					"stages": []
				}
				projects.push(newProject);

				loadLayout(projects.length - 1);
				loadSidenav();
			}

			function addStage() {
				let newStage = {
					"title": "New stage",
					"cards": {}
				}

				currentProject["stages"].push(newStage);

				loadContent();
			}

			function addCard() {
				let card = {
					"text": "Hello, World!"
				}

				let stageIndex = this.parentNode.cellIndex;
				let cardId;

				while (true) {
					cardId = genId();


					/*
					Checking if the generated Id already exists; I feel weird
					not checking this, sorry. But what if all 340282366920938463463374607431768211456
					possible solutions are used? FUCK
					*/

					let allCardIds = [];
					for (var project of projects) {
						for (var stage of project["stages"]) {
							for (var _cardId of Object.keys(stage["cards"])) {
								allCardIds.push(_cardId);
							}
						}
					}

					if (!allCardIds.includes(cardId)) {
						break;
					}
				}


				currentProject["stages"][stageIndex]["cards"][cardId] = card;
				loadContent();
			}

			function calcCursorDistance(element, mx, my) {
				// From https://www.kirupa.com/html5/get_element_position_using_javascript.htm

				var xPos = 0;
				var yPos = 0;

				let _element = element;
				while (element) {
					xPos += (element.offsetLeft - element.scrollLeft + element.clientLeft);
					yPos += (element.offsetTop - element.scrollTop + element.clientTop);
					element = element.offsetParent;
				}

				// Positions of element
				let x1 = xPos;
				let y1 = yPos;

				// Positions of mouse
				let x2 = mx - (_element.clientWidth / 2);
				let y2 = my - (_element.clientHeight / 2);

				// Calculate distance
				let dist = Math.sqrt(Math.pow(x1 - x2, 2) + Math.pow(y1 - y2, 2));

				return dist;
			}

			function cardRemove(id) {
				let removed = false;
				for (var stageIndex in currentProject["stages"]) {
					for (var cardId of Object.keys(currentProject["stages"][stageIndex]["cards"])) {
						if (cardId == id) {
							delete currentProject["stages"][stageIndex]["cards"][cardId];
							removed = true;
							break
						}
					}

					if (removed) {break}
				}

				loadContent();
			}

			function cardAdd(id, content, posY) {
				currentProject["stages"][cellIndex][id] = content;
			}

			function getChildIndex(child) {
				var i = 0;
				while ((child = child.previousSibling) != null) {
					i++;
				}

				return i;
			}

			function insertCardIntoStage(stage, cardId, card, index, goingUp=false) {
				// Mostly from https://stackoverflow.com/questions/63030107/insert-property-into-object-at-specific-index-in-vanilla-js

				if (Object.keys(stage).length == 0) {
					return {cardId: card};
				}

				var cardsArray = Object.entries(stage);
				if (index == 0) {
					var newStagesObject = Object.fromEntries([
					    ...[[cardId, card]],
					    ...cardsArray
					]);
				} else {
					if (goingUp) {
						index--;
					}

					console.log(cardsArray, index);

					var newStagesObject = Object.fromEntries([
					    ...cardsArray.slice(0, index - 1),
					    cardsArray[index - 1],
					    ...[[cardId, card]],
					    ...cardsArray.slice(index)
					]);
				}

				return newStagesObject;
			}

			function findStageFromId(id) {
				for (var stage of currentProject["stages"]) {
					for (var card of Object.keys(stage["cards"])) {
						if ("card-" + card == id) {
							return stage["title"];
						}
					}
				}
				return false;
			}

			function getCardsFromStage(stageTitle) {
				for (var stage of currentProject["stages"]) {
					if (stage["title"] == stageTitle) {
						return stage["cards"];
					}
				}
			}

			function getStageIndex(stageTitle) {
				for (var stage in currentProject["stages"]) {
					if (currentProject["stages"][stage]["title"] == stageTitle) {
						return stage;
					}
				}

				return false;
			}

			function dragStart(event) {
				cardContextMenuClose();
				draggedCard = this;
				droppedCard = null;
				setTimeout(() => (this.classList.add("card-content-invisible")), 0);
			}

			function dragEnd(event) {
				clearInterval(dragging);
				draggedCard = null;
				this.classList.remove("card-content-invisible");
				loadContent();
			}

			function dragEnter(event) {}

			function dragOver(event) {
				/*
				this.style.paddingBottom = "15px";

				this.classList.remove("drop-area-hover-leave");
				this.classList.add("drop-area-hover");
				*/

				event.preventDefault();
			}

			function dragDrop(event) {
				if (draggedCard == null) {return}

				let x = event.target.cellIndex;
				let y = getChildIndex(event.target.parentNode) / 2 - 1;
				let cardId = draggedCard.id.slice(5);

				// findStageFromId can return false, add an error for this
				let stage = findStageFromId(draggedCard.id);
				let newStage = currentProject["stages"][x]["title"];
				let stageIndex = getStageIndex(newStage);

				var goingUp;
				if (stage == newStage) {
					if (Object.keys(getCardsFromStage(stage)).indexOf(cardId) > y) {
						goingUp = false;
					} else {
						goingUp = true;
					}

					if (y == Object.keys(getCardsFromStage(stage)).indexOf(cardId) || y == Object.keys(getCardsFromStage(stage)).indexOf(cardId) + 1) {
						return;
					}
				} else {
					inSameStage = false;
				}

				// Temporary save card
				let card = getCardsFromStage(stage)[cardId];

				// Remove card from stage
				delete getCardsFromStage(stage)[cardId];

				// Add card to stage
				let newCards = insertCardIntoStage(currentProject["stages"][stageIndex]["cards"], cardId, card, y, goingUp);

				currentProject["stages"][stageIndex]["cards"] = newCards;

				droppedCard = cardId;
			}

			function dragLeave(event) {
				/*
				this.classList.remove("drop-area-hover");
				this.classList.add("drop-area-hover-leave");
				*/
			}

			function dragging(event) {
				if (draggedCard == null) {return}

				var closestElement = null;  // The element
				var closestDistance = null;  // The distance of this element
				var dist;

				// Get the closest drop area element relative to mouse
				for (var dropArea of document.getElementsByClassName("drop-area")) {
					dist = calcCursorDistance(dropArea, event.x, event.y);
					if ((closestDistance == null || closestElement == null) || dist < closestDistance) {
						closestDistance = dist;
						closestElement = dropArea;
					}
				}

				if (closestDistance == null || closestElement == null) {
					return;
				}

				if (closestDistance < 150) {  // Doesn't really work yet
					// Remove styles of other classes that are not near the cursor
					for (var el of document.getElementsByClassName("drop-area")) {
						if (el != closestElement) {
							el.classList.remove("drop-area-hover");
							el.classList.add("drop-area-hover-leave");
						}
					}

					closestElement.classList.remove("drop-area-hover-leave");
					closestElement.classList.add("drop-area-hover");
				}
			}

			function loadContent() {
				let table = document.getElementById("board").getElementsByTagName("table")[0];
				table.innerHTML = "";

				let stageRow = document.createElement("tr");
				for (var stageIndex in currentProject["stages"]) {
					let stageTitle = document.createElement("th");

					let stageTitleInput = document.createElement("input");
					stageTitleInput.classList.add("content-table-title");
					stageTitleInput.value = currentProject["stages"][stageIndex]["title"];
					stageTitleInput.spellcheck = false;

					stageTitle.appendChild(stageTitleInput);
					stageRow.appendChild(stageTitle);
				}

				table.appendChild(stageRow);

				// Add the row for all the "add card" buttons
				let stageButtonsRow = document.createElement("tr");
				stageButtonsRow.id = "buttons-table-row"
				for (var stageIndex in currentProject["stages"]) {
					// Add "add card" button
					let addCardButtonElement = document.createElement("td");

					let addCardButton = document.createElement("div");
					addCardButton.classList.add("add-button");
					addCardButton.style.display = "block";
					addCardButton.style.marginLeft = "auto";
					addCardButton.style.marginRight = "auto";
					addCardButton.style.marginTop = "0px";

					addCardButton.innerHTML = "+ Card";
					addCardButton.onclick = addCard;
					addCardButtonElement.appendChild(addCardButton);

					stageButtonsRow.appendChild(addCardButtonElement);

				}

				table.appendChild(stageButtonsRow);


				var dropAreaRow = document.createElement("tr");
				for (var i = 0; i < Object.keys(currentProject["stages"]).length; i++) {
					let dropArea = document.createElement("td");
					dropArea.classList.add("drop-area");

					dropArea.addEventListener("dragenter", dragEnter);
					dropArea.addEventListener("dragover", dragOver);
					dropArea.addEventListener("drop", dragDrop);
					dropArea.addEventListener("dragleave", dragLeave);
					dropAreaRow.appendChild(dropArea);
				}
				table.appendChild(dropAreaRow);

				let level = 0;
				while (true) {
					let allUndefined = true;
					let elementsList = [];
					let row = document.createElement("tr");
					row.classList.add("content-table-row");

					for (var stage of currentProject["stages"]) {
						let card = document.createElement("td");
						card.classList.add("card");
						card.draggable = true;
						card.ondragstart = dragStart;
						card.ondragend = dragEnd;
						card.oncontextmenu = cardContextMenu;

						let textContentKey = Object.keys(stage["cards"])[level];

						let textElement = document.createElement("input");
						textElement.classList.add("card-content")

						if (textContentKey !== undefined) {
							let textContent = stage["cards"][textContentKey]["text"];
							card.id = "card-" + textContentKey;

							allUndefined = false;
							textElement.value = textContent;
							elementsList.push(textContent);
						} else {
							textElement.value = "";
							card.style.opacity = 0;
							elementsList.push(undefined);
						}

						card.appendChild(textElement);

						row.appendChild(card);
					}

					table.appendChild(row);

					var dropAreaRow = document.createElement("tr");
					for (var i = 0; i < Object.keys(currentProject["stages"]).length; i++) {
						/*
						if (currentProject["stages"][i].length == 0) {
							continue;
						}
						*/

						let dropArea = document.createElement("td");
						dropArea.classList.add("drop-area");

						if (elementsList[i] !== undefined) {
							dropArea.addEventListener("dragenter", dragEnter);
							dropArea.addEventListener("dragover", dragOver);
							dropArea.addEventListener("drop", dragDrop);
							dropArea.addEventListener("dragleave", dragLeave);
						}
						dropAreaRow.appendChild(dropArea);
					}
					table.appendChild(dropAreaRow);

					level++;
					if (allUndefined) {
						break;
					}
				}

				let dropArea = document.createElement("div");
				dropArea.addEventListener("dragEnter", dragEnter);
				dropArea.addEventListener("dragOver", dragOver);
				dropArea.addEventListener("dragDrop", dragDrop);
				dropArea.addEventListener("dragLeave", dragLeave);

				if (droppedCard != null) {
					try {
						let tempCard = document.getElementById("card-" + droppedCard);
						let tempCardContent = tempCard.firstElementChild;
						tempCard.classList.add("card-drop-animation");
						tempCardContent.classList.add("card-content-drop-animation");
						setTimeout(function() {
							tempCard.classList.remove("card-drop-animation");
							tempCardContent.classList.remove("card-content-drop-animation");
						}, 1500);
					} catch (e) {

					}
				}
			}

			var currentProject;
			var settings = {
				"slide-context-menu-card": true
			}

			var draggedCard = null;
			var droppedCard = null;  // Id

			document.body.ondrag = dragging;
			document.body.onclick = cardContextMenuClose;

			loadLayout(0);
			loadSidenav();
			loadContent();
		</script>
	</body>
</html>
